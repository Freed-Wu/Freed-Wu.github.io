<!DOCTYPE html>
<html>
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>C 语言错误输出及日志 | wzy</title>
<meta name="generator" content="Jekyll v4.4.1">
<meta property="og:title" content="C 语言错误输出及日志">
<meta name="author" content="Wu Zhenyu">
<meta property="og:locale" content="zh_CN">
<meta name="description" content="不要重复造轮子。 – 佚名">
<meta property="og:description" content="不要重复造轮子。 – 佚名">
<link rel="canonical" href="https://freed-wu.github.io/2024/01/01/c-log.html">
<meta property="og:url" content="https://freed-wu.github.io/2024/01/01/c-log.html">
<meta property="og:site_name" content="wzy">
<meta property="og:image" content="https://pic2.zhimg.com/v2-d3d225ac45efdb35889e0d284f682c1f_1440w.jpg">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-01-01T00:00:00+00:00">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://pic2.zhimg.com/v2-d3d225ac45efdb35889e0d284f682c1f_1440w.jpg">
<meta property="twitter:title" content="C 语言错误输出及日志">
<meta name="twitter:site" content="@FreedWu">
<meta name="twitter:creator" content="@Wu Zhenyu">
<meta property="fb:admins" content="100057378480375">
<meta property="article:publisher" content="100057378480375">
<meta property="fb:app_id" content="100057378480375">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wu Zhenyu","url":"https://Freed-Wu.github.io"},"dateModified":"2024-01-01T00:00:00+00:00","datePublished":"2024-01-01T00:00:00+00:00","description":"不要重复造轮子。 – 佚名","headline":"C 语言错误输出及日志","image":"https://pic2.zhimg.com/v2-d3d225ac45efdb35889e0d284f682c1f_1440w.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://freed-wu.github.io/2024/01/01/c-log.html"},"url":"https://freed-wu.github.io/2024/01/01/c-log.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="icon" href="https://github.com/Freed-Wu.png">
    <link rel="apple-touch-icon" href="https://github.com/Freed-Wu.png">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/poole/lanyon/public/css/poole.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/poole/lanyon/public/css/lanyon.min.css">
    <link rel="stylesheet" href="//jekyllrb.com/css/screen.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css/github-markdown.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <script async src="https://kit.fontawesome.com/556f02e0e5.js"></script>
    <script async src="//cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget/autoload.min.js"></script>
    <!-- https://github.com/christian-fei/Simple-Jekyll-Search -->
    <script async src="//cdn.jsdelivr.net/npm/simple-jekyll-search/dest/simple-jekyll-search.min.js"></script>
    <script async src="/assets/js/search.js"></script>
  </head>
  <!-- https://github.com/poole/lanyon -->
  <body class="theme-base-08 layout-reverse sidebar-overlay">
    <article class="container">
      <header>
        <h1>C 语言错误输出及日志</h1>
      </header>
      <script src="/assets/js/qr.js"></script>
<small class="post-date">
  <i class="fa-solid fa-calendar-day"></i> 01 Jan 2024
  <i class="fa-solid fa-file-word"></i> 2489 words
  <i class="fa-solid fa-coffee"></i> 9 minutes
  <span id="/2024/01/01/c-log.html" class="leancloud-visitors" data-flag-title="C 语言错误输出及日志">
    <i class="fa-regular fa-eye"></i>
    <span class="leancloud-visitors-count"></span>
  </span>
  <a rel="license" href="//creativecommons.org/licenses/by-sa/4.0/deed.zh">
    <i class="fa-brands fa-creative-commons"></i> BY-SA 4.0
  </a>
  <br>
  <a href="/tag/develop"> <i class="fa-solid fa-tag"></i> develop </a>
  <a href="/tag/c"> <i class="fa-solid fa-tag"></i> c </a>
</small>
<ul>
<li>
<a href="#%E9%94%99%E8%AF%AF%E8%A1%A8%E8%BF%B0">错误表述</a><ul>
<li><a href="#%E4%BD%BF%E7%94%A8%E5%BC%82%E5%B8%B8%E6%88%96%E7%8A%B6%E6%80%81">使用异常或状态</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E5%93%A8%E5%85%B5%E5%80%BC">使用哨兵值</a></li>
</ul>
</li>
<li>
<a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">错误处理</a><ul>
<li><a href="#%E6%97%A0%E5%B0%81%E8%A3%85">无封装</a></li>
<li><a href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%B0%81%E8%A3%85">第一次封装</a></li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%B0%81%E8%A3%85">第二次封装</a></li>
</ul>
</li>
<li>
<a href="#%E6%97%A5%E5%BF%97">日志</a><ul>
<li><a href="#%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4">内核空间</a></li>
<li><a href="#%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4">用户空间</a></li>
</ul>
</li>
</ul> <blockquote>
  <p>不要重复造轮子。</p>

  <p>– 佚名</p>
</blockquote>

<h2 id="错误表述">错误表述</h2>

<p>C 语言没有异常机制。</p>

<h3 id="使用异常或状态">使用异常或状态</h3>

<p>别的编程语言的函数类似 <code class="language-plaintext highlighter-rouge">y = f(x)</code>, 如果运行会出错就抛出一个异常。</p>

<p>C 很多本来可以没有返回值的函数有返回值 <code class="language-plaintext highlighter-rouge">status = f(x, &amp;y)</code>:
<code class="language-plaintext highlighter-rouge">status</code> 为 0 表示没有出错。</p>

<ul>
  <li>内核空间
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">status == 0</code> 代表没有出错， <code class="language-plaintext highlighter-rouge">status &lt; 0</code> 代表出错， <code class="language-plaintext highlighter-rouge">-status</code> 代表出错类型</li>
    </ul>
  </li>
  <li>用户空间
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">status == 0</code> 代表没有出错， <code class="language-plaintext highlighter-rouge">status &gt; 0</code> 代表出错。 <code class="language-plaintext highlighter-rouge">status</code> 代表出错类型</li>
      <li>
<code class="language-plaintext highlighter-rouge">status &gt; 0</code> 代表没有出错，<code class="language-plaintext highlighter-rouge">status == -1</code>  代表出错。
        <ul>
          <li>通过设置 <code class="language-plaintext highlighter-rouge">errno</code> 来表示出错类型。用 <code class="language-plaintext highlighter-rouge">strerr(errno)</code>,, <code class="language-plaintext highlighter-rouge">perror(NULL)</code> 查看报错（单线程，多线程 <code class="language-plaintext highlighter-rouge">errno</code> 是共享的不行）。</li>
          <li>可以用非负数表示成功的某种状态（比如成功写入了多少个字符）。</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>此类函数有：</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">close()</code>: -1 或 0</li>
  <li>
<code class="language-plaintext highlighter-rouge">fclose()</code>: -1 或 0</li>
  <li>
<code class="language-plaintext highlighter-rouge">write()</code>: -1 或 成功的状态</li>
  <li>
<code class="language-plaintext highlighter-rouge">fwrite()</code>: -1 或 成功的状态</li>
  <li>
<code class="language-plaintext highlighter-rouge">read()</code>: -1 或 成功的状态</li>
  <li>
<code class="language-plaintext highlighter-rouge">fread()</code>: -1 或 成功的状态</li>
  <li>
<code class="language-plaintext highlighter-rouge">fstat()</code>: -1 或 0</li>
  <li>
<code class="language-plaintext highlighter-rouge">ioctl()</code>: -1 或 0</li>
</ul>

<h3 id="使用哨兵值">使用哨兵值</h3>

<p>比如有的编程语言 <code class="language-plaintext highlighter-rouge">y = f(x)</code> ，如果 <code class="language-plaintext highlighter-rouge">y</code> 为 <code class="language-plaintext highlighter-rouge">None</code> 就是出错，否则就是正确的结果。</p>

<p>C 中可以使用 <code class="language-plaintext highlighter-rouge">y = f(x)</code> 其中：</p>

<ul>
  <li>如果 <code class="language-plaintext highlighter-rouge">y</code> 类型是指针，则哨兵值是 <code class="language-plaintext highlighter-rouge">NULL</code>
</li>
  <li>如果 <code class="language-plaintext highlighter-rouge">y</code> 是 <code class="language-plaintext highlighter-rouge">int</code> ，则哨兵值为 -1 。为此 C 还特意 <code class="language-plaintext highlighter-rouge">typedef</code> 了 <code class="language-plaintext highlighter-rouge">ssize_t</code> 来代表有哨兵值的 <code class="language-plaintext highlighter-rouge">size_t</code> 。</li>
</ul>

<p>此类函数有：</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">fopen()</code>: <code class="language-plaintext highlighter-rouge">NULL</code> 或指针</li>
  <li>
<code class="language-plaintext highlighter-rouge">open()</code>: -1 或文件描述符 <code class="language-plaintext highlighter-rouge">fd</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">mmap()</code>: -1 的指针 或地址</li>
  <li>
<code class="language-plaintext highlighter-rouge">malloc()</code>: <code class="language-plaintext highlighter-rouge">NULL</code> 或 指针</li>
</ul>

<p>一般地（笔者观察的规律）：</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">y</code> 是指针的会用 <code class="language-plaintext highlighter-rouge">NULL</code> 做哨兵值</li>
  <li>
<code class="language-plaintext highlighter-rouge">y</code> 是个结构体会用状态。</li>
  <li>
<code class="language-plaintext highlighter-rouge">y</code> 是个非负整数（例如 <code class="language-plaintext highlighter-rouge">fd</code> ）会用 -1 做哨兵值</li>
</ul>

<h2 id="错误处理">错误处理</h2>

<h3 id="无封装">无封装</h3>

<p>因为 <code class="language-plaintext highlighter-rouge">strerr()</code> 会返回所有 <code class="language-plaintext highlighter-rouge">errno</code> 的错误信息，所以可以：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#if 0
bin="$(basename "$0")" &amp;&amp; bin="${bin%%.*}" &amp;&amp; cc "$0" -o"$bin" &amp;&amp; exec ./"$bin" "$@"
#endif
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="cp">#define FILE_NAME "non_existent_file"
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">FILE_NAME</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: %s: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">FILE_NAME</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">chmod</span> +x main.c
<span class="nv">$ </span>./main.c
./main: non_existent_file: No such file or directory
</code></pre></div></div>

<p>这 <code class="language-plaintext highlighter-rouge">fprintf()</code> 明显可以封装一下。</p>

<h3 id="第一次封装">第一次封装</h3>

<p><code class="language-plaintext highlighter-rouge">stdio.h</code> 提供封装好的 <code class="language-plaintext highlighter-rouge">perror()</code> 。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#if 0
bin="$(basename "$0")" &amp;&amp; bin="${bin%%.*}" &amp;&amp; cc "$0" -o"$bin" &amp;&amp; exec ./"$bin" "$@"
#endif
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>
<span class="cp">#define FILE_NAME "doesn't_exist_file"
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">FILE_NAME</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: "</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">perror</span><span class="p">(</span><span class="n">FILE_NAME</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="第二次封装">第二次封装</h3>

<p>如果不需要退出可以使用 <code class="language-plaintext highlighter-rouge">perror()</code> 。如果需要退出可以直接用 <code class="language-plaintext highlighter-rouge">err()</code> 。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#if 0
bin="$(basename "$0")" &amp;&amp; bin="${bin%%.*}" &amp;&amp; cc "$0" -o"$bin" &amp;&amp; exec ./"$bin" "$@"
#endif
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;err.h&gt;</span><span class="cp">
</span>
<span class="cp">#define FILE_NAME "doesn't_exist_file"
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">FILE_NAME</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">err</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span> <span class="n">FILE_NAME</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>不过需要注意 <code class="language-plaintext highlighter-rouge">err.h</code> 是 POSIX C 的头文件不是 ANSI C 的。</p>

<h2 id="日志">日志</h2>

<p>我们的更多需求：</p>

<ul>
  <li>每次 <code class="language-plaintext highlighter-rouge">perror()</code> 的信息能否保存下来以供日后查看？最好保存的时候再记录一些信息，比如时间戳、进程的 PID 等等。</li>
  <li>每次 <code class="language-plaintext highlighter-rouge">fprintf()</code> 的信息能否设定一个等级：调试、信息、通知、警告、错误、致命错误等等？超过某个等级的信息才会被显示？</li>
</ul>

<h3 id="内核空间">内核空间</h3>

<p><code class="language-plaintext highlighter-rouge">linux/module.h</code> 中的 <code class="language-plaintext highlighter-rouge">printk("XXX")</code> 的输入的第一个字符（不可见字符）用来表达等级 。如果第一个字符不是不可见字符，则使用默认的等级。
所以使用的时候经常 <code class="language-plaintext highlighter-rouge">printk(LEVEL "XXX")</code> 。</p>

<h3 id="用户空间">用户空间</h3>

<p>POSIX C 的 <code class="language-plaintext highlighter-rouge">syslog.h</code> 中的 <code class="language-plaintext highlighter-rouge">syslog(LEVEL, "XXX")</code> 。默认不打印输出结果。日志的输出结果需要通过一个 <code class="language-plaintext highlighter-rouge">syslogd</code> 的守护进程记录。常见的 <code class="language-plaintext highlighter-rouge">syslogd</code> 包括：</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">journalctl</code>： <code class="language-plaintext highlighter-rouge">systemd</code> 自带。 <code class="language-plaintext highlighter-rouge">journalctl -fn0 -tprogram_name</code> 。使用和 <code class="language-plaintext highlighter-rouge">systemd</code> 一样的环境变量 <code class="language-plaintext highlighter-rouge">SYSTEMD_XXX</code> 。例如 <code class="language-plaintext highlighter-rouge">SYSTEMD_COLORS=1</code> 可以强制输出颜色无论输出是否是终端。</li>
  <li><code class="language-plaintext highlighter-rouge">syslogd-ng</code></li>
</ul>

<div class="reward">
  <button id="rewardButton" disable="enable" onclick="toggle()">
    如果这篇博客帮助到你，可以请我喝一杯奶茶~
  </button>
  <table id="rewardQRs">
    <tr>
      <td class="reward_qr"><img src="https://user-images.githubusercontent.com/32936898/199681341-1c5cfa61-4411-4b67-b268-7cd87c5867bb.png" alt="https://user-images.githubusercontent.com/32936898/199681341-1c5cfa61-4411-4b67-b268-7cd87c5867bb.png" height="300pt"></td>
      <td class="reward_qr"><img src="https://user-images.githubusercontent.com/32936898/199681363-1094a0be-85ca-49cf-a410-19b3d7965120.png" alt="https://user-images.githubusercontent.com/32936898/199681363-1094a0be-85ca-49cf-a410-19b3d7965120.png" height="300pt"></td>
      <td class="reward_qr"><img src="https://user-images.githubusercontent.com/32936898/199681368-c34c2be7-e0d8-43ea-8c2c-d3e865da6aeb.png" alt="https://user-images.githubusercontent.com/32936898/199681368-c34c2be7-e0d8-43ea-8c2c-d3e865da6aeb.png" height="300pt"></td>
    </tr>
  </table>
</div>
<script src="/assets/js/valine.js"></script>

    </article>
    <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">
    <aside class="sidebar">
      <div class="sidebar-item">
        <div class="ih-item">
          <a title="
              Wu Zhenyu
            ">
            <img class="img" src="https://github.com/Freed-Wu.png" alt="img">
            <div class="info">
              <br>
              <br>
              A personal blog to record valuable and interesting things.
            </div>
          </a>
        </div>
        <iframe height="42" width="240" src="https://music.163.com/outchain/player?type=2&id=27646786&height=32"></iframe>
      </div>
      <nav class="sidebar-nav">
        <a class="sidebar-nav-item" href="/">
          <i class="fa-solid fa-home fa-fw"></i> Home
        </a>
        <a class="sidebar-nav-item" href="/tag">
          <i class="fa-solid fa-tags fa-fw"></i> Tag
        </a>
        <a class="sidebar-nav-item" href="/feed.xml">
          <i class="fa-solid fa-rss fa-fw"></i> RSS
        </a>
        <a class="sidebar-nav-item" href="/Freed-Wu">
          <i class="fa-solid fa-comments fa-fw"></i> About Me
        </a>
        <a class="sidebar-nav-item" href="/jekyll-theme-freed">
          <i class="fa-solid fa-code fa-fw"></i> About the Website
        </a>
        <a class="sidebar-nav-item" href="/2020/01/01/honour">
          <i class="fa-solid fa-trophy fa-fw"></i> Honour
        </a>
      </nav>
      <div class="sidebar-item">
        <!-- https://github.com/christian-fei/Simple-Jekyll-Search#preparing-the-plugin -->
        <input id="search-input" placeholder="Search posts">
        <div id="results-container"></div>
      </div>
    </aside>
    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
  </body>
</html>
