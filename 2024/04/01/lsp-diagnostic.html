<!DOCTYPE html>
<html>
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Re: 从零开始的语言服务器开发冒险：代码诊断 | wzy</title>
<meta name="generator" content="Jekyll v4.4.1">
<meta property="og:title" content="Re: 从零开始的语言服务器开发冒险：代码诊断">
<meta name="author" content="Wu Zhenyu">
<meta property="og:locale" content="zh_CN">
<meta name="description" content="倘若我们当中哪一位偶尔想与人交交心或谈谈自己的感受，对方无论怎样回应，十有八九都会使他不快，因为他发现与他对话的人在顾左右而言他。他自己表达的，确实是他在日复一日的思虑和苦痛中凝结起来的东西，他想传达给对方的，也是长期经受等待和苦恋煎熬的景象。对方却相反，认为他那些感情都是俗套，他的痛苦俯仰皆是，他的惆怅人皆有之。 – 加缪 《鼠疫》">
<meta property="og:description" content="倘若我们当中哪一位偶尔想与人交交心或谈谈自己的感受，对方无论怎样回应，十有八九都会使他不快，因为他发现与他对话的人在顾左右而言他。他自己表达的，确实是他在日复一日的思虑和苦痛中凝结起来的东西，他想传达给对方的，也是长期经受等待和苦恋煎熬的景象。对方却相反，认为他那些感情都是俗套，他的痛苦俯仰皆是，他的惆怅人皆有之。 – 加缪 《鼠疫》">
<link rel="canonical" href="https://freed-wu.github.io/2024/04/01/lsp-diagnostic.html">
<meta property="og:url" content="https://freed-wu.github.io/2024/04/01/lsp-diagnostic.html">
<meta property="og:site_name" content="wzy">
<meta property="og:image" content="https://pic2.zhimg.com/v2-d3d225ac45efdb35889e0d284f682c1f_1440w.jpg">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-04-01T00:00:00+00:00">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://pic2.zhimg.com/v2-d3d225ac45efdb35889e0d284f682c1f_1440w.jpg">
<meta property="twitter:title" content="Re: 从零开始的语言服务器开发冒险：代码诊断">
<meta name="twitter:site" content="@FreedWu">
<meta name="twitter:creator" content="@Wu Zhenyu">
<meta property="fb:admins" content="100057378480375">
<meta property="article:publisher" content="100057378480375">
<meta property="fb:app_id" content="100057378480375">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wu Zhenyu","url":"https://Freed-Wu.github.io"},"dateModified":"2024-04-01T00:00:00+00:00","datePublished":"2024-04-01T00:00:00+00:00","description":"倘若我们当中哪一位偶尔想与人交交心或谈谈自己的感受，对方无论怎样回应，十有八九都会使他不快，因为他发现与他对话的人在顾左右而言他。他自己表达的，确实是他在日复一日的思虑和苦痛中凝结起来的东西，他想传达给对方的，也是长期经受等待和苦恋煎熬的景象。对方却相反，认为他那些感情都是俗套，他的痛苦俯仰皆是，他的惆怅人皆有之。 – 加缪 《鼠疫》","headline":"Re: 从零开始的语言服务器开发冒险：代码诊断","image":"https://pic2.zhimg.com/v2-d3d225ac45efdb35889e0d284f682c1f_1440w.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://freed-wu.github.io/2024/04/01/lsp-diagnostic.html"},"url":"https://freed-wu.github.io/2024/04/01/lsp-diagnostic.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="icon" href="https://github.com/Freed-Wu.png">
    <link rel="apple-touch-icon" href="https://github.com/Freed-Wu.png">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/poole/lanyon/public/css/poole.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/poole/lanyon/public/css/lanyon.min.css">
    <link rel="stylesheet" href="//jekyllrb.com/css/screen.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css/github-markdown.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <script async src="https://kit.fontawesome.com/556f02e0e5.js"></script>
    <script async src="//cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget/autoload.min.js"></script>
    <!-- https://github.com/christian-fei/Simple-Jekyll-Search -->
    <script async src="//cdn.jsdelivr.net/npm/simple-jekyll-search/dest/simple-jekyll-search.min.js"></script>
    <script async src="/assets/js/search.js"></script>
  </head>
  <!-- https://github.com/poole/lanyon -->
  <body class="theme-base-08 layout-reverse sidebar-overlay">
    <article class="container">
      <header>
        <h1>Re: 从零开始的语言服务器开发冒险：代码诊断</h1>
      </header>
      <script src="/assets/js/qr.js"></script>
<small class="post-date">
  <i class="fa-solid fa-calendar-day"></i> 01 Apr 2024
  <i class="fa-solid fa-file-word"></i> 8274 words
  <i class="fa-solid fa-coffee"></i> 28 minutes
  <span id="/2024/04/01/lsp-diagnostic.html" class="leancloud-visitors" data-flag-title="Re: 从零开始的语言服务器开发冒险：代码诊断">
    <i class="fa-regular fa-eye"></i>
    <span class="leancloud-visitors-count"></span>
  </span>
  <a rel="license" href="//creativecommons.org/licenses/by-sa/4.0/deed.zh">
    <i class="fa-brands fa-creative-commons"></i> BY-SA 4.0
  </a>
  <br>
  <a href="/tag/develop"> <i class="fa-solid fa-tag"></i> develop </a>
  <a href="/tag/lsp"> <i class="fa-solid fa-tag"></i> lsp </a>
</small>
<ul>
<li>
<a href="#%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91">抽象语法树</a><ul>
<li><a href="#%E8%A7%A3%E6%9E%90%E5%99%A8">解析器</a></li>
<li><a href="#%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE">语法高亮</a></li>
<li><a href="#%E8%AF%AD%E4%B9%89%E9%AB%98%E4%BA%AE">语义高亮</a></li>
</ul>
</li>
<li>
<a href="#%E5%AE%9E%E8%B7%B5">实践</a><ul>
<li><a href="#tree-sitter">tree sitter</a></li>
<li><a href="#%E4%BB%A3%E7%A0%81%E8%AF%8A%E6%96%AD">代码诊断</a></li>
<li><a href="#%E5%8F%8D%E6%80%9D">反思</a></li>
</ul>
</li>
</ul> <blockquote>
  <p>倘若我们当中哪一位偶尔想与人交交心或谈谈自己的感受，对方无论怎样回应，十有八九都会使他不快，因为他发现与他对话的人在顾左右而言他。他自己表达的，确实是他在日复一日的思虑和苦痛中凝结起来的东西，他想传达给对方的，也是长期经受等待和苦恋煎熬的景象。对方却相反，认为他那些感情都是俗套，他的痛苦俯仰皆是，他的惆怅人皆有之。</p>

  <p>– 加缪 《鼠疫》</p>
</blockquote>

<p>书接上文。继续分享一些“在日复一日的思虑和苦痛中凝结起来的东西”。</p>

<h2 id="抽象语法树">抽象语法树</h2>

<p>树是计算机科学中一个相当知名的数据结构。抽象语法树上的每一个节点都代表源代码的某个结构：函数体、变量名等等。</p>

<h3 id="解析器">解析器</h3>

<p>解析器将源代码转变为抽象语法树。</p>

<p>一般语言服务器要用到的解析器有如下 3 个来源：</p>

<ul>
  <li>该语言的编译器/解释器一定包含一个解析器，好处是解析结果一定和编译器/解释器完全一致
    <ul>
      <li>
<a href="https://github.com/clangd/clangd">clangd</a>: 其解析器来源于 <a href="https://github.com/llvm/llvm-project">clang</a>, C/C++ 编译器</li>
      <li>
<a href="https://github.com/nix-community/nixd">nixd</a>: 其解析器来源于 <a href="https://github.com/nixos/nix">nix</a>, nix lang 解释器</li>
      <li>
<a href="https://github.com/wader/jq-lsp">jq-lsp</a>: 其解析器来源于 <a href="https://github.com/itchyny/gojq">gojq</a>, jq 解释器</li>
      <li>
<a href="https://github.com/davidhalter/jedi">jedi</a>: 提供 python REPL 的代码补全，被 <a href="https://github.com/pappasam/jedi-language-server">jedi-languag-server</a> 封装为语言服务器，其解析器就是 python 内置的 <code class="language-plaintext highlighter-rouge">import ast</code>
</li>
    </ul>
  </li>
  <li>如果该语言是图灵完备的，可以用该语言实现一个解析器，好处是不用引入外部语言的依赖
    <ul>
      <li>
<a href="https://github.com/vim-jp/vim-vimlparser">vim-vimlparser</a>: vim script</li>
    </ul>
  </li>
  <li>tree-sitter: 好处是通用
    <ul>
      <li>微软的 <a href="https://github.com/microsoft/pyright">pyright</a>
</li>
    </ul>
  </li>
</ul>

<h3 id="语法高亮">语法高亮</h3>

<p>抽象语法树可以被用来实现语法高亮。常见的语法高亮方案是：</p>

<ul>
  <li>基于正则表达式
    <ul>
      <li>
<a href="https://github.com/pygments/pygments">pygments</a>:
        <ul>
          <li>格式： python</li>
          <li>最初用于 python 程序</li>
          <li>也可用于 LaTeX 的 minted 宏包</li>
        </ul>
      </li>
      <li>
<a href="https://github.com/rouge-ruby/rouge">rouge</a>:
        <ul>
          <li>格式： ruby</li>
          <li>最初用于 ruby 程序</li>
        </ul>
      </li>
      <li>
<a href="https://ctan.org/pkg/listings">listings</a>:
        <ul>
          <li>格式： LaTeX</li>
          <li>最初用于 LaTeX</li>
        </ul>
      </li>
      <li>
<a href="https://macromates.com/manual/en/language_grammars">tmLanguage</a>:
        <ul>
          <li>格式： XML</li>
          <li>最初用于 TextMate</li>
          <li>现也用于 VS Code</li>
        </ul>
      </li>
      <li>
<a href="https://www.sublimetext.com/docs/syntax.html">sublime syntax</a>:
        <ul>
          <li>格式： yaml</li>
          <li>最初用于 Sublime</li>
          <li>现也用于 <a href="github.com/sharkdp/bat">bat</a>
</li>
          <li>语法实质是 tmLanguage 的超集， Sublime 可以直接将 tmLanguage 转换为 sublime syntax</li>
        </ul>
      </li>
      <li>VimSyn:
        <ul>
          <li>格式： vim script</li>
          <li>用于 Vim, NeoVim</li>
          <li><a href="https://github.com/vim/vim/issues/9087">名称来源</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>基于抽象语法树
    <ul>
      <li>
<a href="https://github.com/tree-sitter/tree-sitter">tree-sitter</a>:
        <ul>
          <li>原始格式是 javascript ，生成 C 代码，最后编译为二进制文件。</li>
          <li>最初用于 Atom</li>
          <li>也可用于 NeoVim, VS Code 的<a href="https://github.com/EvgeniyPeshkov/syntax-highlighter">某些插件</a> , helix, kakoune, <a href="https://github.com/foxfriends/syncat">syncat</a>
</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><a href="https://github.com/sharkdp/bat/blob/master/doc/alternatives.md">性能对比</a>。</p>

<ul>
  <li>VimSyn 和 tree-sitter 的<a href="https://github.com/nvim-treesitter/nvim-treesitter/wiki/Gallery">结果对比</a>：</li>
</ul>

<p><img src="https://user-images.githubusercontent.com/2361214/202753610-e923bf4e-e88f-494b-bb1e-d22a7688446f.png" alt="example-cpp"></p>

<ul>
  <li>在 VS Code 中使能 tree-sitter 前后的结果对比：</li>
</ul>

<p><img src="https://github.com/EvgeniyPeshkov/syntax-highlighter/raw/master/images/demo.gif" alt="vs code"></p>

<h3 id="语义高亮">语义高亮</h3>

<p>语言服务器协议中有语义 token 这一 feature ，语法和语义的区别见下：</p>

<p>语法：</p>

<p><img src="https://github.com/Freed-Wu/Freed-Wu.github.io/assets/32936898/22db5546-3d44-4798-ad9a-72740fc09c25" alt="py_"></p>

<p><img src="https://github.com/Freed-Wu/Freed-Wu.github.io/assets/32936898/5e18a588-caa0-44f3-a78d-a54ee030af0a" alt="c_"></p>

<p>语义：</p>

<p><img src="https://github.com/Freed-Wu/Freed-Wu.github.io/assets/32936898/1e6d862b-f748-4fdf-9237-2623bd4e8812" alt="py"></p>

<p><img src="https://github.com/Freed-Wu/Freed-Wu.github.io/assets/32936898/656d4ca2-fb2c-45a6-bc54-4a33000aa331" alt="c"></p>

<h2 id="实践">实践</h2>

<h3 id="tree-sitter">tree sitter</h3>

<p>接下来参考 <a href="https://tree-sitter.github.io/tree-sitter/creating-parsers">tree-sitter</a> 文档，我们来选一门比较简单的 DSL 实现一个解析器~</p>

<p>介绍一下 zathurarc ，这是 vim 开发 LaTeX 的插件 <a href="https://github.com/lervag/vimtex">vimtex</a> 首推的 pdf 浏览器 <a href="https://github.com/pwmt/zathura">zathura</a> 的配置语言。 zathurarc 文档并未给出 EBNF 范式。所以根据描述来理解它的语法。</p>

<p>先支持一下注释。我们编写一个 <code class="language-plaintext highlighter-rouge">grammar.js</code> 。我们降低了空格的优先级以确保在任何时候空格都会最后被分隔。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nf">grammar</span><span class="p">({</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">zathurarc</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">rules</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">file</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">repeat</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="nf">optional</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">_code</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">_end</span><span class="p">)),</span>
        <span class="na">_code</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="sr">/</span><span class="se">[^</span><span class="sr">#</span><span class="se">]</span><span class="sr">*/</span><span class="p">,</span>

        <span class="na">comment</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="sr">/#</span><span class="se">[^\n]</span><span class="sr">*/</span><span class="p">,</span>
        <span class="na">_eol</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="sr">/</span><span class="se">\r?\n</span><span class="sr">/</span><span class="p">,</span>
        <span class="na">_space</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">prec</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nf">repeat1</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr"> </span><span class="se">\t]</span><span class="sr">/</span><span class="p">)),</span>
        <span class="na">_end</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">optional</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">_space</span><span class="p">),</span> <span class="nf">optional</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">comment</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">_eol</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree-sitter generate
<span class="nv">$ </span>tree-sitter parse tests/zathurarc
<span class="o">(</span>file <span class="o">[</span>0, 0] - <span class="o">[</span>7, 0]
    <span class="o">(</span>comment <span class="o">[</span>0, 0] - <span class="o">[</span>0, 6]<span class="o">)</span>
    <span class="o">(</span>comment <span class="o">[</span>2, 26] - <span class="o">[</span>2, 40]<span class="o">)</span>
<span class="o">(</span>comment <span class="o">[</span>3, 26] - <span class="o">[</span>3, 43]<span class="o">))</span>
</code></pre></div></div>

<p>注释可以被成功识别。代码因为以 <code class="language-plaintext highlighter-rouge">_</code> 开头被隐藏了。</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code># test
<span class="nb">include</span> desktop/zathurarc
<span class="nb">map</span> <span class="p">[</span>normal<span class="p">]</span> <span class="p">&lt;</span>Esc<span class="p">&gt;</span> zoom <span class="k">in</span>#with <span class="k">argument</span>
<span class="nb">map</span> <span class="p">&lt;</span>F1<span class="p">&gt;</span> recolor          #without <span class="k">argument</span>
<span class="k">set</span> recolor false
unmap <span class="p">&lt;</span>F1<span class="p">&gt;</span>
unmap <span class="p">[</span>normal<span class="p">]</span> <span class="p">&lt;</span>Esc<span class="p">&gt;</span>
</code></pre></div></div>

<p>除开注释只有 4 种语法：</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">set option value</code>: 设置选项， <code class="language-plaintext highlighter-rouge">value</code> 可以是布尔、整数、浮点数、字符串</li>
  <li>
<code class="language-plaintext highlighter-rouge">map [mode] &lt;binding&gt; &lt;shortcut function&gt; &lt;argument&gt;</code>: 映射快捷键</li>
  <li>
<code class="language-plaintext highlighter-rouge">unmap [mode] &lt;binding&gt;</code>: 取消映射快捷键</li>
  <li>
<code class="language-plaintext highlighter-rouge">include &lt;config_path&gt;</code>: 文件包含</li>
</ul>

<p>先支持一下 4 种类型。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">int</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="sr">/</span><span class="se">\d</span><span class="sr">+/</span><span class="p">,</span>
        <span class="nx">float</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">choice</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="nf">optional</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">int</span><span class="p">),</span> <span class="dl">"</span><span class="s2">.</span><span class="dl">"</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">int</span><span class="p">),</span> <span class="nf">seq</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">int</span><span class="p">,</span> <span class="nf">optional</span><span class="p">(</span><span class="dl">"</span><span class="s2">.</span><span class="dl">"</span><span class="p">))),</span>
        <span class="nx">string</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">choice</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">_quoted_string</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">_word</span><span class="p">),</span>
        <span class="nx">bool</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">choice</span><span class="p">(</span><span class="dl">"</span><span class="s2">true</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">false</span><span class="dl">"</span><span class="p">),</span>

        <span class="nx">_word</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">repeat1</span><span class="p">(</span><span class="sr">/</span><span class="se">(\S</span><span class="sr">|</span><span class="se">\\</span><span class="sr"> </span><span class="se">)</span><span class="sr">/</span><span class="p">),</span>
        <span class="nx">_quoted_string</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nf">choice</span><span class="p">(</span>
            <span class="nf">seq</span><span class="p">(</span><span class="dl">'</span><span class="s1">"</span><span class="dl">'</span><span class="p">,</span> <span class="nf">field</span><span class="p">(</span><span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">,</span> <span class="nf">repeat1</span><span class="p">(</span><span class="sr">/</span><span class="se">[^</span><span class="sr">"</span><span class="se">]</span><span class="sr">|</span><span class="se">\\</span><span class="sr">"/</span><span class="p">)),</span> <span class="dl">'</span><span class="s1">"</span><span class="dl">'</span><span class="p">),</span>
            <span class="nf">seq</span><span class="p">(</span><span class="dl">"</span><span class="s2">'</span><span class="dl">"</span><span class="p">,</span> <span class="nf">field</span><span class="p">(</span><span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">,</span> <span class="nf">repeat1</span><span class="p">(</span><span class="sr">/</span><span class="se">[^</span><span class="sr">'</span><span class="se">]</span><span class="sr">|</span><span class="se">\\</span><span class="sr">'/</span><span class="p">)),</span> <span class="dl">"</span><span class="s2">'</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">),</span>
</code></pre></div></div>

<p>于是 <code class="language-plaintext highlighter-rouge">set</code> 就很简单了。因为其他 3 种指令还没实现，所以先注释了：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">_code</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nf">choice</span><span class="p">(</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">set_directive</span><span class="p">,</span>
            <span class="c1">// $.include_directive,</span>
            <span class="c1">// $.map_directive,</span>
            <span class="c1">// $.unmap_directive</span>
        <span class="p">),</span>

        <span class="nx">set_directive</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nf">seq</span><span class="p">(</span>
            <span class="nf">alias</span><span class="p">(</span><span class="dl">"</span><span class="s2">set</span><span class="dl">"</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">command</span><span class="p">),</span>
            <span class="nf">alias</span><span class="p">(</span><span class="nf">repeat1</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">a-z-</span><span class="se">]</span><span class="sr">/</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">option</span><span class="p">),</span>
            <span class="nf">choice</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">int</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">float</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">bool</span><span class="p">)</span>
        <span class="p">),</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree-sitter generate
Unresolved conflict <span class="k">for </span>symbol sequence:

<span class="s1">'set'</span>  set_directive_repeat1  int  •  comment  …

Possible interpretations:

1:  <span class="s1">'set'</span>  set_directive_repeat1  <span class="o">(</span>float  int<span class="o">)</span>  •  comment  …
2:  <span class="o">(</span>set_directive  <span class="s1">'set'</span>  set_directive_repeat1  int<span class="o">)</span>  •  comment  …

Possible resolutions:

1:  Specify a higher precedence <span class="k">in</span> <span class="sb">`</span>float<span class="sb">`</span> than <span class="k">in </span>the other rules.
2:  Specify a higher precedence <span class="k">in</span> <span class="sb">`</span>set_directive<span class="sb">`</span> than <span class="k">in </span>the other rules.
3:  Add a conflict <span class="k">for </span>these rules: <span class="sb">`</span>set_directive<span class="sb">`</span>, <span class="sb">`</span>float<span class="sb">`</span>
</code></pre></div></div>

<p>好好好，浮点数 <code class="language-plaintext highlighter-rouge">a.b</code> 有被识别为整数 <code class="language-plaintext highlighter-rouge">a</code> 的可能。我们提高浮点数的优先级。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">int</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="sr">/</span><span class="se">\d</span><span class="sr">+/</span><span class="p">,</span>
        <span class="nx">float</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nf">prec</span><span class="p">(</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="nf">choice</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="nf">optional</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">int</span><span class="p">),</span> <span class="dl">"</span><span class="s2">.</span><span class="dl">"</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">int</span><span class="p">),</span> <span class="nf">seq</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">int</span><span class="p">,</span> <span class="nf">optional</span><span class="p">(</span><span class="dl">"</span><span class="s2">.</span><span class="dl">"</span><span class="p">)))</span>
        <span class="p">),</span>
        <span class="nx">string</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">choice</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">_quoted_string</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">_word</span><span class="p">),</span>
        <span class="nx">bool</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">choice</span><span class="p">(</span><span class="dl">"</span><span class="s2">true</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">false</span><span class="dl">"</span><span class="p">),</span>

        <span class="nx">_word</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">repeat1</span><span class="p">(</span><span class="sr">/</span><span class="se">(\S</span><span class="sr">|</span><span class="se">\\</span><span class="sr"> </span><span class="se">)</span><span class="sr">/</span><span class="p">),</span>
        <span class="nx">_quoted_string</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nf">choice</span><span class="p">(</span>
            <span class="nf">seq</span><span class="p">(</span><span class="dl">'</span><span class="s1">"</span><span class="dl">'</span><span class="p">,</span> <span class="nf">field</span><span class="p">(</span><span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">,</span> <span class="nf">repeat1</span><span class="p">(</span><span class="sr">/</span><span class="se">[^</span><span class="sr">"</span><span class="se">]</span><span class="sr">|</span><span class="se">\\</span><span class="sr">"/</span><span class="p">)),</span> <span class="dl">'</span><span class="s1">"</span><span class="dl">'</span><span class="p">),</span>
            <span class="nf">seq</span><span class="p">(</span><span class="dl">"</span><span class="s2">'</span><span class="dl">"</span><span class="p">,</span> <span class="nf">field</span><span class="p">(</span><span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">,</span> <span class="nf">repeat1</span><span class="p">(</span><span class="sr">/</span><span class="se">[^</span><span class="sr">'</span><span class="se">]</span><span class="sr">|</span><span class="se">\\</span><span class="sr">'/</span><span class="p">)),</span> <span class="dl">"</span><span class="s2">'</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">),</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree-sitter generate
<span class="nv">$ </span>tree-sitter parse tests/zathurarc
<span class="o">(</span>file <span class="o">[</span>0, 0] - <span class="o">[</span>7, 0]
    <span class="o">(</span>comment <span class="o">[</span>0, 0] - <span class="o">[</span>0, 6]<span class="o">)</span>
    <span class="o">(</span>ERROR <span class="o">[</span>1, 0] - <span class="o">[</span>2, 26]<span class="o">)</span>
    <span class="o">(</span>comment <span class="o">[</span>2, 26] - <span class="o">[</span>2, 40]<span class="o">)</span>
    <span class="o">(</span>ERROR <span class="o">[</span>3, 0] - <span class="o">[</span>3, 16]
    <span class="o">(</span>int <span class="o">[</span>3, 6] - <span class="o">[</span>3, 7]<span class="o">))</span>
    <span class="o">(</span>comment <span class="o">[</span>3, 26] - <span class="o">[</span>3, 43]<span class="o">)</span>
    <span class="o">(</span>set_directive <span class="o">[</span>4, 0] - <span class="o">[</span>4, 17]
        <span class="o">(</span><span class="nb">command</span> <span class="o">[</span>4, 0] - <span class="o">[</span>4, 3]<span class="o">)</span>
        <span class="o">(</span>option <span class="o">[</span>4, 4] - <span class="o">[</span>4, 11]<span class="o">)</span>
    <span class="o">(</span>bool <span class="o">[</span>4, 12] - <span class="o">[</span>4, 17]<span class="o">))</span>
    <span class="o">(</span>ERROR <span class="o">[</span>5, 0] - <span class="o">[</span>6, 20]
<span class="o">(</span>int <span class="o">[</span>5, 8] - <span class="o">[</span>5, 9]<span class="o">)))</span>
tests/zathurarc 0 ms    <span class="o">(</span>ERROR <span class="o">[</span>1, 0] - <span class="o">[</span>2, 26]<span class="o">)</span>
</code></pre></div></div>

<p>我们注意到无法被解析的节点的类型是 <code class="language-plaintext highlighter-rouge">ERROR</code> 。事实上后面我们就是用这种方法来实现语言服务器的代码诊断的。
再补上剩下 3 种指令：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">_code</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nf">choice</span><span class="p">(</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">set_directive</span><span class="p">,</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">include_directive</span><span class="p">,</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">map_directive</span><span class="p">,</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">unmap_directive</span>
        <span class="p">),</span>

        <span class="c1">// ...</span>

        <span class="nx">include_directive</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nf">seq</span><span class="p">(</span><span class="nf">alias</span><span class="p">(</span><span class="dl">"</span><span class="s2">include</span><span class="dl">"</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">command</span><span class="p">),</span> <span class="nf">alias</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">_word</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">path</span><span class="p">)),</span>

        <span class="nx">unmap_directive</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nf">seq</span><span class="p">(</span><span class="nf">alias</span><span class="p">(</span><span class="dl">"</span><span class="s2">unmap</span><span class="dl">"</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">command</span><span class="p">),</span> <span class="nf">optional</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">mode</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">key</span><span class="p">),</span>

        <span class="nx">map_directive</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nf">seq</span><span class="p">(</span>
            <span class="nf">alias</span><span class="p">(</span><span class="dl">"</span><span class="s2">map</span><span class="dl">"</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">command</span><span class="p">),</span>
            <span class="nf">optional</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">mode</span><span class="p">),</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span>
            <span class="nf">alias</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">a-z_</span><span class="se">]</span><span class="sr">+/</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="kd">function</span><span class="p">),</span>
            <span class="nf">optional</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">_space</span><span class="p">,</span> <span class="nf">alias</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">a-z_</span><span class="se">]</span><span class="sr">+/</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">argument</span><span class="p">)))</span>
        <span class="p">),</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">tree-sitter generate</code> 提示存在冲突，并给出了提高优先级或声明 <code class="language-plaintext highlighter-rouge">conlicts</code> 的解决方法：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree-sitter generate
Unresolved conflict <span class="k">for </span>symbol sequence:

<span class="s1">'map'</span>  key  <span class="s1">'map_directive_token1'</span>  •  <span class="s1">'_space_token1'</span>  …

Possible interpretations:

1:  <span class="o">(</span>map_directive  <span class="s1">'map'</span>  key  <span class="s1">'map_directive_token1'</span>  •  _space  <span class="s1">'map_directive_token1'</span><span class="o">)</span>
2:  <span class="o">(</span>map_directive  <span class="s1">'map'</span>  key  <span class="s1">'map_directive_token1'</span><span class="o">)</span>  •  <span class="s1">'_space_token1'</span>  …

Possible resolutions:

1:  Specify a left or right associativity <span class="k">in</span> <span class="sb">`</span>map_directive<span class="sb">`</span>
2:  Add a conflict <span class="k">for </span>these rules: <span class="sb">`</span>map_directive<span class="sb">`</span>
</code></pre></div></div>

<p>采纳一个：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nf">grammar</span><span class="p">({</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">zathurarc</span><span class="dl">"</span><span class="p">,</span>

    <span class="na">conflicts</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="p">[</span><span class="nx">$</span><span class="p">.</span><span class="nx">map_directive</span><span class="p">]</span>
    <span class="p">],</span>

    <span class="c1">// ...</span>
<span class="p">})</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree-sitter generate
<span class="nv">$ </span>tree-sitter parse tests/zathurarc
<span class="o">(</span>file <span class="o">[</span>0, 0] - <span class="o">[</span>7, 0]
    <span class="o">(</span>comment <span class="o">[</span>0, 0] - <span class="o">[</span>0, 6]<span class="o">)</span>
    <span class="o">(</span>include_directive <span class="o">[</span>1, 0] - <span class="o">[</span>1, 25]
        <span class="o">(</span><span class="nb">command</span> <span class="o">[</span>1, 0] - <span class="o">[</span>1, 7]<span class="o">)</span>
    <span class="o">(</span>path <span class="o">[</span>1, 8] - <span class="o">[</span>1, 25]<span class="o">))</span>
    <span class="o">(</span>map_directive <span class="o">[</span>2, 0] - <span class="o">[</span>2, 26]
        <span class="o">(</span><span class="nb">command</span> <span class="o">[</span>2, 0] - <span class="o">[</span>2, 3]<span class="o">)</span>
        <span class="o">(</span>mode <span class="o">[</span>2, 4] - <span class="o">[</span>2, 12]
        <span class="o">(</span>mode_name <span class="o">[</span>2, 5] - <span class="o">[</span>2, 11]<span class="o">))</span>
        <span class="o">(</span>key <span class="o">[</span>2, 13] - <span class="o">[</span>2, 18]
        <span class="o">(</span>key_name <span class="o">[</span>2, 14] - <span class="o">[</span>2, 17]<span class="o">))</span>
        <span class="o">(</span><span class="k">function</span> <span class="o">[</span>2, 19] - <span class="o">[</span>2, 23]<span class="o">)</span>
    <span class="o">(</span>argument <span class="o">[</span>2, 24] - <span class="o">[</span>2, 26]<span class="o">))</span>
    <span class="o">(</span>comment <span class="o">[</span>2, 26] - <span class="o">[</span>2, 40]<span class="o">)</span>
    <span class="o">(</span>map_directive <span class="o">[</span>3, 0] - <span class="o">[</span>3, 16]
        <span class="o">(</span><span class="nb">command</span> <span class="o">[</span>3, 0] - <span class="o">[</span>3, 3]<span class="o">)</span>
        <span class="o">(</span>key <span class="o">[</span>3, 4] - <span class="o">[</span>3, 8]
        <span class="o">(</span>key_name <span class="o">[</span>3, 5] - <span class="o">[</span>3, 7]<span class="o">))</span>
    <span class="o">(</span><span class="k">function</span> <span class="o">[</span>3, 9] - <span class="o">[</span>3, 16]<span class="o">))</span>
    <span class="o">(</span>comment <span class="o">[</span>3, 26] - <span class="o">[</span>3, 43]<span class="o">)</span>
    <span class="o">(</span>set_directive <span class="o">[</span>4, 0] - <span class="o">[</span>4, 17]
        <span class="o">(</span><span class="nb">command</span> <span class="o">[</span>4, 0] - <span class="o">[</span>4, 3]<span class="o">)</span>
        <span class="o">(</span>option <span class="o">[</span>4, 4] - <span class="o">[</span>4, 11]<span class="o">)</span>
    <span class="o">(</span>bool <span class="o">[</span>4, 12] - <span class="o">[</span>4, 17]<span class="o">))</span>
    <span class="o">(</span>unmap_directive <span class="o">[</span>5, 0] - <span class="o">[</span>5, 10]
        <span class="o">(</span><span class="nb">command</span> <span class="o">[</span>5, 0] - <span class="o">[</span>5, 5]<span class="o">)</span>
        <span class="o">(</span>key <span class="o">[</span>5, 6] - <span class="o">[</span>5, 10]
    <span class="o">(</span>key_name <span class="o">[</span>5, 7] - <span class="o">[</span>5, 9]<span class="o">)))</span>
    <span class="o">(</span>unmap_directive <span class="o">[</span>6, 0] - <span class="o">[</span>6, 20]
        <span class="o">(</span><span class="nb">command</span> <span class="o">[</span>6, 0] - <span class="o">[</span>6, 5]<span class="o">)</span>
        <span class="o">(</span>mode <span class="o">[</span>6, 6] - <span class="o">[</span>6, 14]
        <span class="o">(</span>mode_name <span class="o">[</span>6, 7] - <span class="o">[</span>6, 13]<span class="o">))</span>
        <span class="o">(</span>key <span class="o">[</span>6, 15] - <span class="o">[</span>6, 20]
<span class="o">(</span>key_name <span class="o">[</span>6, 16] - <span class="o">[</span>6, 19]<span class="o">))))</span>
</code></pre></div></div>

<p>还有一堆问题，比如：</p>

<ul>
  <li>转义 <code class="language-plaintext highlighter-rouge">\#</code> 。</li>
  <li>按 <code class="language-plaintext highlighter-rouge">zathurarc</code> 的语法， <code class="language-plaintext highlighter-rouge">"true"</code> 也算布尔型（这太坑了）。</li>
</ul>

<p>但对大多数情况这个解析器已经足矣。</p>

<p>编写<a href="https://tree-sitter.github.io/tree-sitter/creating-parsers#command-test">单元测试</a>，另外我们需要提供对各种语言的绑定。</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">tree-sitter generate</code> 目前会生成对 rust 和 javascript 的绑定。</li>
  <li>除此之外对 C, Go, Python, Swift 和 Zig 的绑定也已经在 PR 阶段。</li>
  <li>一些常用的解析器的 python 绑定已经被第三方库 <a href="https://github.com/grantjenks/py-tree-sitter-languages">tree-sitter-languages</a> 实现。可以不用造轮子。</li>
</ul>

<p>在 PR 合并之前，我们可以简单的编写一个 python 的绑定。考虑到 <a href="https://github.com/tree-sitter/tree-sitter/pull/2438/">#2438</a> 会被合并以及本文的重点只和语言服务器有关，不做太详细的介绍：</p>

<p><a href="https://github.com/tree-sitter/py-tree-sitter">py-tree-sitter</a> 提供了用于 python 的绑定的应用编程接口。我们只需要额外在 python 项目提供一个 C 语言的二进制构建后端。这样的<a href="https://scikit-build-core.readthedocs.io/en/latest/index.html#other-projects-for-building">后端很多</a>，笔者选择了使用 <a href="https://scikit-build-core.readthedocs.io/"><code class="language-plaintext highlighter-rouge">scikit-build-core</code></a> 通过编写 <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> 完成。</p>

<p>本部分代码开源于 <a href="https://github.com/Freed-Wu/tree-sitter-zathurarc">tree-sitter-zathurarc</a> 。</p>

<h3 id="代码诊断">代码诊断</h3>

<p>我们可以实现代码诊断了。 tree-sitter 提供了一门内置叫做 <a href="https://tree-sitter.github.io/tree-sitter/using-parsers#pattern-matching-with-queries">tree-sitter-query</a> 的 Lisp 方言。我们可以用它来获取所有的 <code class="language-plaintext highlighter-rouge">ERROR</code> 节点：</p>

<div class="language-scheme highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ERROR</span><span class="p">)</span> <span class="nv">@error</span>
</code></pre></div></div>

<p>先创建一个语言服务器，添加代码诊断功能。它只会在文件打开和改动后向第一行添加一个 <code class="language-plaintext highlighter-rouge">hello, error!</code> 的报错：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">lsprotocol.types</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pygls.server</span> <span class="kn">import</span> <span class="n">LanguageServer</span>


<span class="k">class</span> <span class="nc">ZathuraLanguageServer</span><span class="p">(</span><span class="n">LanguageServer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="nd">@self.feature</span><span class="p">(</span><span class="n">TEXT_DOCUMENT_DID_OPEN</span><span class="p">)</span>
        <span class="nd">@self.feature</span><span class="p">(</span><span class="n">TEXT_DOCUMENT_DID_CHANGE</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">did_change</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">DidChangeTextDocumentParams</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">diagnostics</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nc">Diagnostic</span><span class="p">(</span>
                    <span class="nc">Range</span><span class="p">(</span><span class="nc">Position</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nc">Position</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="sh">"</span><span class="s">hello, error!</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">DiagnosticSeverity</span><span class="p">.</span><span class="n">Error</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">publish_diagnostics</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">text_document</span><span class="p">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/Freed-Wu/Freed-Wu.github.io/assets/32936898/146def59-1191-4994-8a3b-9febc9408c8a" alt="hello"></p>

<p>这样的报错毫无意义。让我们从 python 的绑定中获取解析器和用于解析 tree-sitter-query 的 <code class="language-plaintext highlighter-rouge">language</code> 。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">tree_sitter_zathurarc</span> <span class="kn">import</span> <span class="n">parser</span><span class="p">,</span> <span class="n">language</span>


<span class="k">class</span> <span class="nc">ZathuraLanguageServer</span><span class="p">(</span><span class="n">LanguageServer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">trees</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nd">@self.feature</span><span class="p">(</span><span class="n">TEXT_DOCUMENT_DID_OPEN</span><span class="p">)</span>
        <span class="nd">@self.feature</span><span class="p">(</span><span class="n">TEXT_DOCUMENT_DID_CHANGE</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">did_change</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">DidChangeTextDocumentParams</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">document</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">workspace</span><span class="p">.</span><span class="nf">get_document</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">text_document</span><span class="p">.</span><span class="n">uri</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">trees</span><span class="p">[</span><span class="n">document</span><span class="p">.</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">document</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="nf">encode</span><span class="p">())</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">language</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="sh">"</span><span class="s">(ERROR) @error</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">captures</span> <span class="o">=</span> <span class="n">query</span><span class="p">.</span><span class="nf">captures</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">trees</span><span class="p">[</span><span class="n">document</span><span class="p">.</span><span class="n">uri</span><span class="p">].</span><span class="n">root_node</span><span class="p">)</span>
            <span class="n">error_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">capture</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">capture</span> <span class="ow">in</span> <span class="n">captures</span><span class="p">]</span>
            <span class="n">diagnostics</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nc">Diagnostic</span><span class="p">(</span>
                    <span class="nc">Range</span><span class="p">(</span>
                        <span class="nc">Position</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">.</span><span class="n">start_point</span><span class="p">),</span> <span class="nc">Position</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">.</span><span class="n">end_point</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="sh">"</span><span class="s">parse error</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">DiagnosticSeverity</span><span class="p">.</span><span class="n">Error</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">error_nodes</span>
            <span class="p">]</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">publish_diagnostics</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">text_document</span><span class="p">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://github.com/Freed-Wu/Freed-Wu.github.io/assets/32936898/3e3c1e97-7f4d-45f1-b290-80ac74fac03f" alt="parse"></p>

<p>我们很快得到了我们想要的 <code class="language-plaintext highlighter-rouge">:)</code> 。</p>

<p>本部分代码开源于 <a href="https://github.com/Freed-Wu/zathura-language-server">zathura-language-server</a> 。</p>

<h3 id="反思">反思</h3>

<p>仅仅是检测错误的语法恐怕还不够。比如：</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">set</span> font <span class="m">42</span>
</code></pre></div></div>

<p>这符合我们刚刚提到的 <code class="language-plaintext highlighter-rouge">set option value</code> 的语法，但：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>zathura /the/path/of/your.pdf
error: Unable to load CSS: &lt;data&gt;:5:15Expected a string.
</code></pre></div></div>

<p>因为字体不可能是一个整数。</p>

<p>这样的设定并不少见。比如 vim, tmux, mutt 等软件均有 <code class="language-plaintext highlighter-rouge">set option value</code> 的语法，我们必须对选项值的合法性做代码诊断。</p>

<p>把选项值的合法性的代码诊断放到 <code class="language-plaintext highlighter-rouge">grammar.js</code> 中可以吗？</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">set_directive</span><span class="p">:</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nf">seq</span><span class="p">(</span>
            <span class="nf">alias</span><span class="p">(</span><span class="dl">"</span><span class="s2">set</span><span class="dl">"</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">command</span><span class="p">),</span>
            <span class="nf">choice</span><span class="p">(</span>
                <span class="nf">seq</span><span class="p">(</span><span class="nf">alias</span><span class="p">(</span><span class="nf">choice</span><span class="p">(</span><span class="dl">"</span><span class="s2">font</span><span class="dl">"</span><span class="p">,</span> <span class="cm">/*...*/</span> <span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">option</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">string</span><span class="p">),</span>
                <span class="nf">seq</span><span class="p">(</span><span class="nf">alias</span><span class="p">(</span><span class="nf">choice</span><span class="p">(</span> <span class="cm">/*...*/</span> <span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">option</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">int</span><span class="p">),</span>
                <span class="nf">seq</span><span class="p">(</span><span class="nf">alias</span><span class="p">(</span><span class="nf">choice</span><span class="p">(</span> <span class="cm">/*...*/</span> <span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">option</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">float</span><span class="p">),</span>
                <span class="nf">seq</span><span class="p">(</span><span class="nf">alias</span><span class="p">(</span><span class="nf">choice</span><span class="p">(</span> <span class="cm">/*...*/</span> <span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">option</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">bool</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
</code></pre></div></div>

<p>可以是可以。但：</p>

<ul>
  <li>所有的报错都是 <code class="language-plaintext highlighter-rouge">parse error</code> 。用户如何知道怎么修改错误？</li>
  <li>合法性的数据被硬编码到了 <code class="language-plaintext highlighter-rouge">grammar.js</code> 中。这不符合编程中代码、数据相分离的原则。</li>
  <li>代码难以复用。不同软件的 <code class="language-plaintext highlighter-rouge">set option value</code> 完全可以把合法性诊断的代码剥离出来抽象为一个新的库。</li>
</ul>

<p>接下来我们将引入新的技术，来告诉用户 <code class="language-plaintext highlighter-rouge">42 is not of type 'string'</code> 。</p>

<p><img src="https://github.com/Freed-Wu/Freed-Wu.github.io/assets/32936898/1973f4de-4569-4022-bde3-abbe7055dfd5" alt="42"></p>

<div class="reward">
  <button id="rewardButton" disable="enable" onclick="toggle()">
    如果这篇博客帮助到你，可以请我喝一杯奶茶~
  </button>
  <table id="rewardQRs">
    <tr>
      <td class="reward_qr"><img src="https://user-images.githubusercontent.com/32936898/199681341-1c5cfa61-4411-4b67-b268-7cd87c5867bb.png" alt="https://user-images.githubusercontent.com/32936898/199681341-1c5cfa61-4411-4b67-b268-7cd87c5867bb.png" height="300pt"></td>
      <td class="reward_qr"><img src="https://user-images.githubusercontent.com/32936898/199681363-1094a0be-85ca-49cf-a410-19b3d7965120.png" alt="https://user-images.githubusercontent.com/32936898/199681363-1094a0be-85ca-49cf-a410-19b3d7965120.png" height="300pt"></td>
      <td class="reward_qr"><img src="https://user-images.githubusercontent.com/32936898/199681368-c34c2be7-e0d8-43ea-8c2c-d3e865da6aeb.png" alt="https://user-images.githubusercontent.com/32936898/199681368-c34c2be7-e0d8-43ea-8c2c-d3e865da6aeb.png" height="300pt"></td>
    </tr>
  </table>
</div>
<script src="/assets/js/valine.js"></script>

    </article>
    <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">
    <aside class="sidebar">
      <div class="sidebar-item">
        <div class="ih-item">
          <a title="
              Wu Zhenyu
            ">
            <img class="img" src="https://github.com/Freed-Wu.png" alt="img">
            <div class="info">
              <br>
              <br>
              A personal blog to record valuable and interesting things.
            </div>
          </a>
        </div>
        <iframe height="42" width="240" src="https://music.163.com/outchain/player?type=2&id=27646786&height=32"></iframe>
      </div>
      <nav class="sidebar-nav">
        <a class="sidebar-nav-item" href="/">
          <i class="fa-solid fa-home fa-fw"></i> Home
        </a>
        <a class="sidebar-nav-item" href="/tag">
          <i class="fa-solid fa-tags fa-fw"></i> Tag
        </a>
        <a class="sidebar-nav-item" href="/feed.xml">
          <i class="fa-solid fa-rss fa-fw"></i> RSS
        </a>
        <a class="sidebar-nav-item" href="/Freed-Wu">
          <i class="fa-solid fa-comments fa-fw"></i> About Me
        </a>
        <a class="sidebar-nav-item" href="/jekyll-theme-freed">
          <i class="fa-solid fa-code fa-fw"></i> About the Website
        </a>
        <a class="sidebar-nav-item" href="/2020/01/01/honour">
          <i class="fa-solid fa-trophy fa-fw"></i> Honour
        </a>
      </nav>
      <div class="sidebar-item">
        <!-- https://github.com/christian-fei/Simple-Jekyll-Search#preparing-the-plugin -->
        <input id="search-input" placeholder="Search posts">
        <div id="results-container"></div>
      </div>
    </aside>
    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
  </body>
</html>
